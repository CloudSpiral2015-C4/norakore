<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" type="text/css" href="css/normalize.css">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/default.css">
	<script type='text/javascript' src="js/jquery-1.11.3.min.js"></script>
	<script type='text/javascript' src="js/bootstrap.js" ></script>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
	<script type='text/javascript' src="js/common.js" ></script>
	<title>テスト</title>
</head>
<body>
	<div id="iphone-wrapper">
	<div id="wrapper">
	<div id="user-info-header"></div>
	<div id="main">
		<h1 class="text-center">猫サーチ</h1>
		<form class="form-horizontal form-custom"  role="form">
            <div class="form-group">
                <label class="col-xs-12">地名入力</label>
                <div class="col-xs-12">
                    <input type="text" class="form-control" id="address" name="address">
                </div>
            </div>
             <div class="form-group">
                <div class="col-xs-offset-2 col-xs-10">
                    <button type="submit" class="btn btn-custom" data-width="30"><p>送信</p></button>
                </div>
            </div>
        </form>
        <!-- 検索した地名の地図を表示する -->
		<h2 class="text-center">Googleマップ</h2>
		<div id="google-map-field"></div>

		<script>
			var geocoder, map;
			function mapInit() {
				geocoder = new google.maps.Geocoder();
				var lat = "";
				var lon = "";
				var center;
    			navigator.geolocation.getCurrentPosition(function(pos) {
            			lat = pos.coords.latitude;
            			lon = pos.coords.longitude;
            			center = new google.maps.LatLng(lat,lon);
						var option = {
							zoom : 13,
							center : center,
							mapTypeId : google.maps.MapTypeId.ROADMAP
						};
						//地図本体描画
						map = new google.maps.Map($("#google-map-field")[0], option);
						//地図上にマーカーを落とす
						//new google.maps.Marker({position : center, map : map});

    					$.ajax({
        					type: 'GET',
        					url: '../api/nyavatar',
        					data: {
            					lat: lat,
            					lon: lon
            				}
            			})
        				.done(function(data) {
                            var nyavatarList = data.list;
        					for(var i = 0; i < nyavatarList.length; ++i) {
        						var marker = new google.maps.Marker({
        							position : new google.maps.LatLng(nyavatarList[i].location.lat,nyavatarList[i].location.lon),
        							map:map
        						});
        					}
        				});
       				},
        			function(e){
            			console.log("ERROR: navigator.geolocation.getCurrentPosition()" + e);
        			}
    			);}
			mapInit();

			function listup() {
			   	var address = $('#address').val();
			   	var lat = "";
				var lon = "";
				var center;
                geocoder = new google.maps.Geocoder();
			    // geocode (住所から緯度経度を取得)
    			geocoder.geocode( { address: address, language: 'ja'}, function(results, status)
    			{
    				if(status==google.maps.GeocoderStatus.OK){
    					center = results[0].geometry.location;
            			lat = center.lat();
            			lon = center.lng();
						var option = {
							zoom : 13,
							center : center,
							mapTypeId : google.maps.MapTypeId.ROADMAP
						};
						map.setOptions(option);
	 					// マーカー
						//new google.maps.Marker({position : center, map : map});

		    			$.ajax({
    		    			type: 'GET',
        					url: '../api/nyavatar',
        					data: {
            					lat: lat,
            					lon: lon
            				}
            			})
        				.done(function(data) {
            				nyavatarList = data.list;
                            console.log(data.list);
                            for(var i = 0; i < nyavatarList.length; ++i) {
                                $.ajax({
                                    type: 'GET',
                                    url: '../api/pic/{' + nyavatarList[i].pictureID + '}.jpg',
                                    data: {

                                    }
                                })
                                .done(function(data){
                                    console.log(data);
                                });
                                var icon = "images/nyavatar.png";
                                var name = nyavatarList[i].name;
                                var date = nyavatarList[i].date.split('T')[0];
                                var like = nyavatarList[i].likeUserList == null ? 0 : nyavatarList[i].likeUserList.length;
                                var picture = "images/neko-img.png";
                                var nyavatarThumbnail = "";
                                nyavatarThumbnail += '<div class="nyavatar-thumbnail">';
                                nyavatarThumbnail += '    <div class="nyavatar-heading">';
                                nyavatarThumbnail += '        <img src="' + icon + '">';
                                nyavatarThumbnail += '        <h4>' + name + '</h4>';
                                nyavatarThumbnail += '    </div>';
                                nyavatarThumbnail += '    <div class="nyavatar-body">';
                                nyavatarThumbnail += '        <div class="pull-left">';
                                nyavatarThumbnail += '            <img src="' + picture + '" class="nyavatar-image">';
                                nyavatarThumbnail += '        </div>';
                                nyavatarThumbnail += '        <div class="nyavatar-status">';
                                nyavatarThumbnail += '            <ul>';
                                nyavatarThumbnail += '                <li>主な生息地: <span class="place">不明</span></li>';
                                nyavatarThumbnail += '                <li>最終発見報告: <span class="date">' + date + '</span></li>';
                                nyavatarThumbnail += '                <li>いいね: <span class="review">' + like + '回</span></li>';
                                nyavatarThumbnail += '            </ul>';
                                nyavatarThumbnail += '        </div>';
                                nyavatarThumbnail += '    </div>';
                                nyavatarThumbnail += '    <div class="clearfix"></div>';
                                nyavatarThumbnail += '    <div class="nyavatar-footer">';
                                nyavatarThumbnail += '        <div class="btn btn-default">詳細</div>';
                                nyavatarThumbnail += '        <div class="btn btn-primary">発見</div>';
                                nyavatarThumbnail += '    </div>';
                                nyavatarThumbnail += '</div>';
                                $('.nyavatar-list').append(nyavatarThumbnail);
                            }
        				});
        			}else{
            			console.log("ERROR: geocoder.geolocation()");
        			}
      			 },
        			function(e){
            			console.log("ERROR: geocoder.geolocation()" + e);
        			});
				}

			// 自動POSTをしないために必要
			$('.form-horizontal').submit(function(e) {
    			e.preventDefault();
   				listup();
    			return false;
			});
		</script>

	<!-- 以下のにゃばたーリストはMap中心地から半径Xkm以内に登録されているにゃばたーを表示する -->
		<h2 class="text-center">マップ付近の　にゃばたーリスト</h2>
		<div class="nyavatar-list"></div>


	</div><!-- main -->

	<div id="menu-button-footer"></div>
	</div>
	</div>
</body>
<script>
	getUserInfoHeader("ゲスト");
	getMenuButtonFooter("ここにはページの説明を書いて下さい．");
</script>
</html>
